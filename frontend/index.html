<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- è®¾ç½® viewport ä»¥æ”¯æŒå®‰å…¨åŒºé€‚é… -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <title>æŸ æª¬å”åŠ©æ‰‹</title>
    <!-- å¼•å…¥ ChatUI æ ¸å¿ƒæ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/@chatui/core/dist/index.css" />
    <style>
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* é˜²æ­¢é¡µé¢æ»šåŠ¨ */
        }
        /* å¯é€‰ï¼šä¸º ChatUI è®¾ç½®ä¸€äº›é»˜è®¤å®‰å…¨åŒºè¾¹è·ï¼Œå¦‚æœ meta æ ‡ç­¾å’Œ CSS å˜é‡æ— æ•ˆ */
        body {
             padding-top: constant(safe-area-inset-top); /* iOS < 11.2 */
             padding-top: env(safe-area-inset-top); /* iOS >= 11.2 */
             padding-bottom: constant(safe-area-inset-bottom);
             padding-bottom: env(safe-area-inset-bottom);
         }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React å’Œ ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel ç”¨äºåœ¨æµè§ˆå™¨ä¸­è½¬è¯‘ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- ChatUI æ ¸å¿ƒåº“ -->
    <script src="https://unpkg.com/@chatui/core/dist/index.js"></script>

    <!-- ä½ çš„ React åº”ç”¨ä»£ç  (ä½¿ç”¨ Babel è½¬è¯‘) -->
    <script type="text/babel">
        // --- DEBUG: Check if ChatUI global exists ---
        console.log("window.ChatUI object:", window.ChatUI);
        // --- END DEBUG ---

        const { useState, useCallback } = React;
        // Correctly access default and named exports from the ChatUI global
        const Chat = ChatUI.default; 
        const { Bubble, useMessages } = ChatUI;

        const App = () => {
            // Check if Chat component is defined now
            if (!Chat) {
                console.error("Chat component is still undefined. Check ChatUI library loading.");
                return <div>Error: Chat component not loaded.</div>;
            }
            // Check if useMessages hook is defined
             if (!useMessages) {
                 console.error("useMessages hook is undefined. Check ChatUI library loading.");
                 return <div>Error: useMessages hook not loaded.</div>;
             }

            // --- DEBUG: Log the result of useMessages and the destructured setTyping --- 
            // const messageManager = useMessages([]); // Remove debug log
            // console.log("Result from useMessages():", messageManager);
            // const { messages, appendMsg, setTyping } = messageManager;
            // console.log("Destructured setTyping:", setTyping);
            // --- END DEBUG --- 

            const { messages, appendMsg } = useMessages([]); // Only destructure what's available

            const apiEndpoint = 'http://localhost:8000/ask'; // åç«¯ API åœ°å€

            // å‘é€æ¶ˆæ¯çš„å¤„ç†å‡½æ•°
            const handleSend = useCallback(async (type, val) => {
                if (type === 'text' && val.trim()) {
                    // 1. æ˜¾ç¤ºç”¨æˆ·å‘é€çš„æ¶ˆæ¯
                    appendMsg({
                        type: 'text',
                        content: { text: val },
                        position: 'right',
                    });

                    // 2. ç§»é™¤ setTyping(true) è°ƒç”¨
                    // setTyping(true);

                    // 3. è°ƒç”¨åç«¯ API
                    try {
                        const response = await fetch(apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ query: val.trim() }),
                        });

                        if (!response.ok) {
                            // å¤„ç† API è¯·æ±‚é”™è¯¯
                            const errorData = await response.json().catch(() => ({ response: 'API è¯·æ±‚å¤±è´¥' }));
                            appendMsg({
                                type: 'text',
                                content: { text: `é”™è¯¯: ${errorData.error || response.statusText}` },
                                position: 'left',
                            });
                            return; // æå‰é€€å‡º
                        }

                        const data = await response.json();
                        
                        // 4. æ˜¾ç¤ºåç«¯è¿”å›çš„å“åº”
                        if (data.response) {
                            appendMsg({
                                type: 'text',
                                content: { text: data.response }, // ä½¿ç”¨ API è¿”å›çš„å†…å®¹
                                position: 'left',
                                // å¯é€‰ï¼šæ˜¾ç¤ºå¤„ç†çš„ Agent åç§°
                                // user: { avatar: 'ğŸ¤–', name: data.handling_agent || 'åŠ©æ‰‹' } 
                            });
                        } else if (data.error) {
                             appendMsg({
                                type: 'text',
                                content: { text: `åç«¯é”™è¯¯: ${data.error}` },
                                position: 'left',
                            });
                        }

                    } catch (error) {
                        // å¤„ç†ç½‘ç»œé”™è¯¯ç­‰
                        console.error("API call failed:", error);
                        appendMsg({
                            type: 'text',
                            content: { text: `ç½‘ç»œé”™è¯¯: ${error.message}` },
                            position: 'left',
                        });
                    } finally {
                       // 5. ç§»é™¤ setTyping(false) è°ƒç”¨
                       // setTyping(false); 
                    }
                }
            }, [appendMsg]); // Remove setTyping from dependency array

            // æ¸²æŸ“æ¶ˆæ¯å†…å®¹
            const renderMessageContent = useCallback((msg) => {
                const { type, content } = msg;
                switch (type) {
                    case 'text':
                        return <Bubble content={content.text} />;
                    default:
                        return null;
                }
            }, []);

            return (
                <Chat
                    navbar={{ title: 'æŸ æª¬å”çš„å°åŠ©æ‰‹' }}
                    messages={messages}
                    renderMessageContent={renderMessageContent}
                    onSend={handleSend}
                    placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜..."
                />
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html> 